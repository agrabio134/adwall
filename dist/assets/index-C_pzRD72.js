import{initializeApp as wt}from"https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";import{getFirestore as bt,doc as J,getDoc as vt,setDoc as It,onSnapshot as Ct}from"https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";import{getAuth as Et,signInAnonymously as xt}from"https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function i(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=i(n);fetch(n.href,a)}})();async function Lt(t,e,i){const o="https://api.pinata.cloud/pinning/pinFileToIPFS",n=new FormData;n.append("file",t);try{const a=await fetch(o,{method:"POST",headers:{pinata_api_key:e,pinata_secret_api_key:i},body:n});if(!a.ok)throw new Error(`Pinata upload failed: ${a.statusText}`);return(await a.json()).IpfsHash}catch(a){throw console.error("Error uploading to Pinata:",a),a}}window.uploadToPinata=Lt;class Tt{constructor({url:e}){this.url=e}async callContract({packageObjectId:e,module:i,function:o,arguments:n}){return null}}window.SuiWallet={getWallet:async()=>({requestAccounts:async()=>["0x6e8b65e7f53772bd5f4d9588f07deb4b30d0fff3a8aa0d4fc6103a92d45fff0a"],signAndExecuteTransaction:async t=>({digest:"mock-digest"})})};const St={apiKey:"AIzaSyBMYvcmBUSlRTlGuFHc_hzBTOBWHv-_tSg",authDomain:"adwall-c2ee6.firebaseapp.com",projectId:"adwall-c2ee6",storageBucket:"adwall-c2ee6.firebasestorage.app",messagingSenderId:"357735706499",appId:"1:357735706499:web:002eb0c35c1762fcdf50b6",measurementId:"G-VYWTFFL6ZK"},ut=wt(St),Q=bt(ut),R=Et(ut),u=200,B=200,c=10;let s=1,w=0,b=0,S=!1,j,U,ft,tt,et;const G=10,Bt=300,r=document.getElementById("ad-grid"),p=r.getContext("2d"),st=document.getElementById("toggle-controls"),kt=document.getElementById("guide-button"),ct=document.getElementById("control-panel"),$=document.getElementById("connect-wallet"),lt=document.getElementById("wallet-address"),_=document.getElementById("width-input"),Y=document.getElementById("height-input"),Mt=document.getElementById("image-upload"),rt=document.getElementById("caption-input"),D=document.getElementById("buy-button"),O=document.getElementById("upload-image-button"),pt=document.getElementById("upload-section"),Pt=document.getElementById("price-per-block"),Dt=document.getElementById("price-display"),Ft=document.getElementById("price-estimation"),dt=document.getElementById("zoom-slider"),k=document.getElementById("tooltip"),q=document.getElementById("toast"),A=document.createElement("div"),mt=document.getElementById("guide-modal"),_t=document.getElementById("close-guide");let H=!1,x=0,L=0,m=new Array(u*B).fill(null),F=new Map,Z,N=null,M=null,T=!0;const Yt="98f595dcac5c827de322",$t="31b9bdfbde939194fb574ef5190424d68108a784505442103479eaf723060646",z="0xf417ef5831a31a5f2f9b28104c79f13bbb6feb74f9ce6f4e8aecfe0818630e63",Ot="https://fullnode.testnet.sui.io:443",V=new Tt({url:Ot});function At(){A.id="loading-screen",A.innerHTML=`
        <div class="loader">
            <div class="cyber-circle"></div>
            <div class="cyber-text">Initializing AdWall Matrix...</div>
        </div>
    `,document.body.appendChild(A);const t=document.createElement("style");t.textContent=`
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        .loader {
            text-align: center;
        }
        .cyber-circle {
            width: 100px;
            height: 100px;
            border: 4px solid #00ffff;
            border-radius: 50%;
            border-top-color: #ff00ff;
            animation: spin 1s linear infinite, pulse 2s infinite;
            margin: 0 auto 20px;
        }
        .cyber-text {
            color: #00ffff;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            text-shadow: 0 0 10px #00ffff;
            animation: flicker 1.5s infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 10px #00ffff; }
            50% { box-shadow: 0 0 20px #ff00ff; }
            100% { box-shadow: 0 0 10px #00ffff; }
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    `,document.head.appendChild(t)}function W(){A.style.opacity="0",setTimeout(()=>{A.style.display="none",T=!1,ht()},500)}async function nt(t,e=1e4){const i=["https://ipfs.io/ipfs/","https://gateway.pinata.cloud/ipfs/","https://cloudflare-ipfs.com/ipfs/"];for(const o of i)try{return await new Promise((n,a)=>{const l=document.createElement("img");l.style.display="none",document.body.appendChild(l);const f=setTimeout(()=>a(new Error("Image load timeout")),e);l.onload=()=>{clearTimeout(f);const h=t.toLowerCase().endsWith(".gif");n({element:l,isGif:h})},l.onerror=()=>{clearTimeout(f),document.body.removeChild(l),a(new Error("Image load failed"))},l.src=`${o}${t.split("/ipfs/")[1]||t}`})}catch(n){if(console.warn(`Failed with gateway ${o}:`,n),o===i[o.length-1])throw n;continue}}function I(t,e=3e3){q.textContent=t,q.classList.add("show"),setTimeout(()=>q.classList.remove("show"),e)}function gt(){const t=window.innerWidth,e=window.innerHeight;r.width=t,r.height=e}function ot(t,e,i){console.log(`Showing tooltip at (${t}, ${e}) with caption: "${i}"`),k.textContent=i||"No caption provided",k.style.left=`${t+10}px`,k.style.top=`${e+10}px`,k.style.display="block"}function it(t=null,e=null){if(T)return;p.clearRect(0,0,r.width,r.height);const i=r.width/(c*s),o=r.height/(c*s);p.save(),p.translate(w,b),p.strokeStyle="rgba(0, 255, 255, 0.2)";const n=Math.max(0,Math.floor(-w/(c*s))),a=Math.max(0,Math.floor(-b/(c*s))),l=Math.min(u,n+Math.ceil(i)+1),f=Math.min(B,a+Math.ceil(o)+1);for(let d=n;d<=l;d++)p.beginPath(),p.moveTo(d*c*s,a*c*s),p.lineTo(d*c*s,f*c*s),p.stroke();for(let d=a;d<=f;d++)p.beginPath(),p.moveTo(n*c*s,d*c*s),p.lineTo(l*c*s,d*c*s),p.stroke();let h=!1;for(let d=0;d<u*B;d++){const g=m[d];if(g&&g.isTopLeft){const y=d%u*c*s,E=Math.floor(d/u)*c*s;if(g.imageCid){const P=F.get(g.imageCid);P&&P.element&&P.element.complete&&P.element.naturalWidth!==0?p.drawImage(P.element,y,E,g.width*c*s,g.height*c*s):(p.fillStyle="rgba(128, 128, 128, 0.3)",p.fillRect(y,E,g.width*c*s,g.height*c*s))}else p.fillStyle="rgba(255, 0, 0, 0.3)",p.fillRect(y,E,g.width*c*s,g.height*c*s),p.strokeStyle="rgba(255, 0, 0, 0.5)",p.strokeRect(y,E,g.width*c*s,g.height*c*s)}}if(t!==null&&e!==null){const d=Math.floor((t-w)/(c*s)),y=Math.floor((e-b)/(c*s))*u+d,E=m[y];if(E&&E.imageCid){const P=(Math.floor(y/u)-(E.isTopLeft?0:E.height-1))*u+y%u-(E.isTopLeft?0:E.width-1),X=m[P];X&&X.isTopLeft&&X.imageCid&&(ot(t,e,X.caption),h=!0)}}h||(k.style.display="none");const v=parseInt(_.value)||1,C=parseInt(Y.value)||1;p.fillStyle="rgba(255, 165, 0, 0.5)",p.strokeStyle="#ffaa00",p.fillRect(x*c*s,L*c*s,v*c*s,C*c*s),p.strokeRect(x*c*s,L*c*s,v*c*s,C*c*s),p.restore()}function ht(){it(),requestAnimationFrame(ht)}async function at(){if(!M){I("Please connect your wallet first",5e3);return}try{if(!R.currentUser)throw new Error("User not authenticated");const e=J(Q,"canvas","gridState"),i={blocks:m.map(o=>o?{owner:o.owner,imageCid:o.imageCid,width:o.width,height:o.height,isTopLeft:o.isTopLeft,caption:o.caption||"No caption set"}:null),timestamp:Date.now()};await It(e,i),console.log("Canvas state saved to Firebase")}catch(t){console.error("Error saving canvas state:",t),I("Failed to save canvas state: "+t.message,5e3)}}async function Xt(){try{const t=J(Q,"canvas","gridState"),e=await vt(t);if(e.exists()){m=e.data().blocks.map(n=>n?{owner:n.owner,imageCid:n.imageCid,width:n.width,height:n.height,isTopLeft:n.isTopLeft,caption:n.caption!==void 0?n.caption:"No caption set"}:null);const o=m.filter(n=>(n==null?void 0:n.imageCid)&&!F.has(n.imageCid)).map(async n=>{try{const a=await nt(`https://ipfs.io/ipfs/${n.imageCid}`);F.set(n.imageCid,a)}catch(a){console.warn(`Failed to load image ${n.imageCid}:`,a)}});return it(),console.log("Canvas state loaded from Firebase:",m.filter(n=>n&&n.imageCid).length,"blocks with images"),W(),await Promise.all(o),!0}return W(),!1}catch(t){return console.error("Error loading canvas state:",t),I("Failed to load canvas state: "+t.message,5e3),W(),!1}}function Rt(){const t=J(Q,"canvas","gridState");Ct(t,e=>{e.exists()&&(m=e.data().blocks.map(o=>o?{owner:o.owner,imageCid:o.imageCid,width:o.width,height:o.height,isTopLeft:o.isTopLeft,caption:o.caption!==void 0?o.caption:"No caption set"}:null),console.log("Realtime update received:",m.filter(o=>o&&o.imageCid).length,"blocks with images"))},e=>{console.error("Realtime listener error:",e),I("Realtime update failed: "+e.message,5e3)})}st.addEventListener("click",()=>{ct.classList.toggle("hidden"),st.textContent=ct.classList.contains("hidden")?"Show Controls":"Hide Controls"});kt.addEventListener("click",()=>{mt.style.display="flex"});_t.addEventListener("click",()=>{mt.style.display="none"});dt.addEventListener("input",()=>{const t=s;s=parseFloat(dt.value);const e=(r.width/2-w)/t,i=(r.height/2-b)/t;w=r.width/2-e*s,b=r.height/2-i*s});$.addEventListener("click",async()=>{try{if(!window.SuiWallet&&(await new Promise(i=>setTimeout(i,1e3)),!window.SuiWallet))throw new Error("Sui Wallet extension not detected. Please install it and refresh.");if(!R||!R.app)throw new Error("Firebase Auth not initialized correctly");Z=await window.SuiWallet.getWallet();const t=await Z.requestAccounts();if(!t||t.length===0)throw new Error("No accounts found");M=t[0],lt.textContent=`${M.slice(0,6)}...${M.slice(-4)}`,console.log("Signing in anonymously...");const e=await xt(R);console.log("Signed in as:",e.user.uid),H=!0,D.disabled=!1,$.textContent="Connected",$.disabled=!0,I("Wallet connected successfully!"),await yt()}catch(t){console.error("Wallet connection failed:",t),I(`Failed to connect wallet: ${t.message}`,5e3),H=!1,D.disabled=!0,$.textContent="Connect Wallet",$.disabled=!1,lt.textContent="Not connected"}});r.addEventListener("mousedown",t=>{T||(S=!0,j=t.clientX-w,U=t.clientY-b,r.style.cursor="grabbing")});r.addEventListener("mousemove",t=>{if(!T)if(S){w=t.clientX-j,b=t.clientY-U;const e=0,i=-(u*c*s-r.width),o=0,n=-(B*c*s-r.height);w=Math.min(e,Math.max(i,w)),b=Math.min(o,Math.max(n,b))}else{const e=r.getBoundingClientRect();it(t.clientX-e.left,t.clientY-e.top)}});r.addEventListener("mouseup",()=>{T||(S=!1,r.style.cursor="default")});r.addEventListener("mouseleave",()=>{T||(S=!1,r.style.cursor="default",k.style.display="none")});r.addEventListener("touchstart",t=>{if(T)return;const e=t.touches[0];tt=e.clientX,et=e.clientY,ft=Date.now(),j=e.clientX-w,U=e.clientY-b,t.preventDefault()});r.addEventListener("touchmove",t=>{if(T)return;const e=t.touches[0],i=e.clientX-tt,o=e.clientY-et;if(!S&&(Math.abs(i)>G||Math.abs(o)>G)&&(S=!0,r.style.cursor="grabbing"),S){w=e.clientX-j,b=e.clientY-U;const n=0,a=-(u*c*s-r.width),l=0,f=-(B*c*s-r.height);w=Math.min(n,Math.max(a,w)),b=Math.min(l,Math.max(f,b))}t.preventDefault()});r.addEventListener("touchend",t=>{if(T)return;const e=t.changedTouches[0],i=e.clientX-tt,o=e.clientY-et,n=Date.now()-ft;if(!S&&Math.abs(i)<=G&&Math.abs(o)<=G&&n<=Bt){const a=r.getBoundingClientRect(),l=e.clientX-a.left,f=e.clientY-a.top,h=Math.floor((l-w)/(c*s)),v=Math.floor((f-b)/(c*s)),C=v*u+h,d=m[C];if(d&&d.imageCid){const g=(Math.floor(C/u)-(d.isTopLeft?0:d.height-1))*u+C%u-(d.isTopLeft?0:d.width-1),y=m[g];if(y&&y.isTopLeft&&y.imageCid){console.log(`Tapped block ${C} (top-left: ${g}) with imageCid: ${y.imageCid}, caption: ${y.caption}`),ot(l,f,y.caption),setTimeout(()=>{k.style.display="none"},3e3);return}}x=Math.max(0,Math.min(h,u-(parseInt(_.value)||1))),L=Math.max(0,Math.min(v,B-(parseInt(Y.value)||1))),K()}S=!1,r.style.cursor="default",t.preventDefault()});r.addEventListener("click",t=>{if(T)return;const e=r.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top,n=Math.floor((i-w)/(c*s)),a=Math.floor((o-b)/(c*s)),l=a*u+n,f=m[l];if(f&&f.imageCid){const h=(Math.floor(l/u)-(f.isTopLeft?0:f.height-1))*u+l%u-(f.isTopLeft?0:f.width-1),v=m[h];if(v&&v.isTopLeft&&v.imageCid){console.log(`Clicked block ${l} (top-left: ${h}) with imageCid: ${v.imageCid}, caption: ${v.caption}`),ot(i,o,v.caption),setTimeout(()=>{k.style.display="none"},3e3);return}}x=Math.max(0,Math.min(n,u-(parseInt(_.value)||1))),L=Math.max(0,Math.min(a,B-(parseInt(Y.value)||1))),K()});_.addEventListener("input",K);Y.addEventListener("input",K);async function K(){const t=parseInt(_.value)||1,e=parseInt(Y.value)||1,i=t*e,o=await Nt(x+L*u);let n=o*i;i>=21?n*=.9:i>=6&&(n*=.95),Pt.textContent=(o/1e9).toFixed(2),Dt.textContent=(n/1e9).toFixed(2);const a=t*2,l=e*2,f=a*l;let h=o*f;f>=21?h*=.9:f>=6&&(h*=.95),Ft.textContent=`${(h/1e9).toFixed(2)} Test SUI for ${a}x${l} blocks`}async function yt(){try{if(!await Xt()&&M){for(let e=0;e<u*B;e++)try{const[i]=await V.callContract({packageObjectId:z,module:"ad_wall",function:"get_block_owner",arguments:[e.toString()]})||["0x0"];if(i!=="0x0"){const[o]=await V.callContract({packageObjectId:z,module:"ad_wall",function:"get_block_image",arguments:[e.toString()]})||[null];if(m[e]={owner:i,imageCid:o||null,width:1,height:1,isTopLeft:!0,caption:o?"No caption set":null},o&&!F.has(o)){const n=await nt(`https://ipfs.io/ipfs/${o}`);F.set(o,n)}}}catch(i){console.warn(`Error fetching block ${e}`,i)}await at()}}catch(t){console.error("Error fetching grid data:",t),I("Failed to fetch grid data: "+t.message,5e3),W()}}async function Nt(t){const e=await V.callContract({packageObjectId:z,module:"ad_wall",function:"get_block_price",arguments:[t.toString()]});return e?e[0]:1e8}D.addEventListener("click",async()=>{if(!H||!M){I("Please connect your wallet first",5e3);return}const t=parseInt(_.value)||1,e=parseInt(Y.value)||1;if(x+t>u||L+e>B){alert("Selected area is outside the grid boundaries.");return}for(let i=0;i<e;i++)for(let o=0;o<t;o++){const n=(L+i)*u+(x+o);if(m[n]){alert("One or more selected blocks are already taken.");return}}D.disabled=!0,D.textContent="Processing...";try{const i={packageObjectId:z,module:"ad_wall",function:"buy_blocks",typeArguments:[],arguments:[x.toString(),L.toString(),t.toString(),e.toString(),""],gasBudget:3e7},o=await Z.signAndExecuteTransaction(i);console.log("Transaction successful:",o);const n=L*u+x;for(let a=0;a<e;a++)for(let l=0;l<t;l++){const f=(L+a)*u+(x+l);m[f]={owner:M,imageCid:null,width:t,height:e,isTopLeft:a===0&&l===0,caption:null}}N=n,pt.style.display="block",I("Blocks purchased successfully! Now upload your ad."),await at()}catch(i){console.error("Purchase failed:",i),I("Failed to buy blocks: "+i.message,5e3)}finally{D.disabled=!1,D.textContent="Buy Blocks"}});O.addEventListener("click",async()=>{if(!N){alert("Please purchase blocks first.");return}if(!H||!M){I("Please connect your wallet first",5e3);return}const t=Mt.files[0];if(!t){alert("Please select an image to upload.");return}const e=rt.value.trim()||null;O.disabled=!0,O.textContent="Uploading...";try{const i=new FormData;i.append("file",t);const a=(await(await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS",{method:"POST",headers:{pinata_api_key:Yt,pinata_secret_api_key:$t},body:i})).json()).IpfsHash,l=m[N],f=l.width,h=l.height;for(let C=0;C<h;C++)for(let d=0;d<f;d++){const g=(L+C)*u+(x+d);m[g].imageCid=a,m[g].caption=e||"No caption set"}const v=await nt(`https://ipfs.io/ipfs/${a}`);F.set(a,v),I("Ad uploaded successfully!"),pt.style.display="none",rt.value="",N=null,await at(),console.log("Uploaded block with imageCid:",a,"caption:",e||"No caption set")}catch(i){console.error("Image upload failed:",i),I("Failed to upload ad: "+i.message,5e3)}finally{O.disabled=!1,O.textContent="Add Ad"}});window.addEventListener("load",()=>{At();const t=document.getElementById("test-phase-note"),e=document.getElementById("close-note"),i=document.getElementById("funding-note"),o=document.getElementById("close-funding-note");t.style.display="block",setTimeout(()=>{e.disabled=!1},3e3),e.addEventListener("click",()=>{t.style.display="none",i.style.display="block"}),o.addEventListener("click",()=>{i.style.display="none"}),yt(),Rt()});window.addEventListener("load",async()=>{console.log("Grid Data Loaded on Refresh",m),gt()});window.addEventListener("resize",gt);
